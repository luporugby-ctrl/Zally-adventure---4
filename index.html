<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zally's Data Flow: Training Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --zalando-orange: #ff6900;
            --zalando-black: #1a1a1a;
            --gemini-blue: #4285f4;
            --pipe-color: #555;
            --water-color: #00bcd4;
            --bg-color: #222;
            --success-green: #4caf50;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Press Start 2P', cursive; /* Retro font per titoli */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            border: 4px solid var(--zalando-orange);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background: #111;
        }

        canvas {
            display: block;
        }

        /* UI Overlay Superiore */
        #ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid white;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Pulsante Azione Principale */
        #action-bar {
            margin-top: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .action-btn {
            background: var(--zalando-orange);
            color: white;
            border: 4px solid #fff;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #b34a00;
            transition: transform 0.1s;
        }
        
        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #b34a00;
        }

        .action-btn.gemini {
            background: var(--gemini-blue);
            box-shadow: 0 4px 0 #2a5db0;
        }

        /* Finestre Modali (Istruzioni, Quiz) */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--zalando-black);
            border: 4px solid white;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            width: 500px;
            display: none;
            z-index: 100;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            font-family: 'Roboto', sans-serif; /* Font pi√π leggibile per testi lunghi */
        }

        .modal h2 {
            font-family: 'Press Start 2P', cursive;
            color: var(--zalando-orange);
            margin-top: 0;
            font-size: 18px;
            line-height: 1.5;
        }

        .modal p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #ddd;
        }

        .modal .tutorial-keys {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
        }

        .key-badge {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            border-bottom: 3px solid #222;
        }

        /* Stile Quiz Gemini */
        #gemini-ui {
            background: white;
            color: black;
            border-color: var(--gemini-blue);
        }
        
        #gemini-ui h2 { color: var(--gemini-blue); }
        #gemini-ui p { color: #333; font-weight: bold; }

        .quiz-option {
            background: #f0f4f8;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #d1d9e6;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            text-align: left;
        }

        .quiz-option:hover {
            background: #e8f0fe;
            border-color: var(--gemini-blue);
        }

        /* Mobile Controls */
        #mobile-controls {
            display: none;
            margin-top: 10px;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }
        
        @media (max-width: 800px) {
            #mobile-controls { display: flex; }
            canvas { width: 100%; height: auto; }
            .action-btn { padding: 10px; font-size: 10px; }
            h1 { font-size: 14px; }
        }

        .d-pad-btn {
            width: 50px;
            height: 50px;
            background: #333;
            border: 2px solid #555;
            color: white;
            font-size: 20px;
            border-radius: 8px;
        }

    </style>
</head>
<body>

    <!-- Titolo -->
    <h1 style="margin-bottom: 10px; color: var(--zalando-orange); text-shadow: 2px 2px 0 #000;">ZALLY OPS: PIPE TRAINING</h1>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        
        <!-- UI In-Game -->
        <div id="ui-overlay">
            <div class="stat-box">LIVELLO: <span id="level-display">1</span></div>
            <div class="stat-box" id="status-display">MODALIT√Ä COSTRUZIONE</div>
        </div>

        <!-- MODAL: Start / Istruzioni -->
        <div id="start-modal" class="modal" style="display:block;">
            <h2>BENVENUTO NEL TEAM OPS!</h2>
            <p>Il nostro flusso di dati √® interrotto. Dobbiamo connettere i dati grezzi (DATA) al Report finale.</p>
            <p><strong>Come giocare:</strong></p>
            <div class="tutorial-keys">
                <div class="key-badge">FRECCE<br>Muovi Zally</div>
                <div class="key-badge">SPAZIO<br>Ruota Tubo</div>
            </div>
            <p>Alcuni tubi sono <strong>ROSSI</strong> (bloccati). Vai sopra e premi <strong>INVIO</strong> per chiedere a Gemini come sbloccarli.</p>
            <p>Non c'√® fretta. Quando sei pronto, premi "APRI FLUSSO".</p>
            <button class="action-btn" onclick="startGame()">INIZIA TRAINING</button>
        </div>

        <!-- MODAL: Gemini Quiz -->
        <div id="gemini-ui" class="modal">
            <h2>‚ú® AIUTO GEMINI</h2>
            <p id="gemini-question">Domanda qui...</p>
            <div id="gemini-options">
                <!-- Opzioni inserite via JS -->
            </div>
        </div>

        <!-- MODAL: Risultato -->
        <div id="result-modal" class="modal">
            <h2 id="result-title">TITOLO</h2>
            <p id="result-msg">Messaggio</p>
            <button id="result-btn" class="action-btn" onclick="nextLevel()">PROSSIMO</button>
        </div>
    </div>

    <!-- Barra Azioni -->
    <div id="action-bar">
        <button class="action-btn" onclick="checkGemini()" title="Usa su caselle rosse">‚ú® CHIEDI A GEMINI (INVIO)</button>
        <button class="action-btn" onclick="testFlow()" style="background:var(--success-green); border-color:#fff;" title="Prova il flusso">üíß APRI FLUSSO (F)</button>
    </div>

    <!-- Controlli Mobile -->
    <div id="mobile-controls">
        <div style="width:100%; text-align:center; margin-bottom:5px;">
            <button class="d-pad-btn" onclick="input('ArrowUp')">‚¨ÜÔ∏è</button>
        </div>
        <div style="width:100%; text-align:center; margin-bottom:5px;">
            <button class="d-pad-btn" onclick="input('ArrowLeft')">‚¨ÖÔ∏è</button>
            <button class="d-pad-btn" onclick="input('Space')">üîÑ</button>
            <button class="d-pad-btn" onclick="input('ArrowRight')">‚û°Ô∏è</button>
        </div>
        <div style="width:100%; text-align:center;">
            <button class="d-pad-btn" onclick="input('ArrowDown')">‚¨áÔ∏è</button>
        </div>
    </div>

<script>
/**
 * ZALLY OPS TRAINING - LOGICA DI GIOCO SEMPLIFICATA
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Configurazione
const TILE_SIZE = 60;
const COLS = 10;
const ROWS = 10;

// Asset Colori
const COLORS = {
    bg: '#111',
    grid: '#222',
    pipeNormal: '#555',
    pipeWater: '#00bcd4',
    glitch: '#e91e63', // Rosso per errori
    zally: '#ff6900', // Arancione Zalando
    start: '#4caf50',
    end: '#ffeb3b'
};

// Stato del Gioco
let level = 1;
let zally = { x: 0, y: 0 };
let grid = [];
let isFlowing = false; // Se l'acqua sta scorrendo
let gameActive = false;

// DEFINIZIONE LIVELLI
const LEVELS = [
    {
        id: 1,
        title: "LIVELLO 1: PULIZIA DATI",
        msg: "I dati dei fornitori sono sporchi! Usa Smart Fill per pulirli.",
        glitchCount: 2, // Tubi bloccati da risolvere con Gemini
        geminiTask: 'cleaning',
        pipes: 'simple' // Layout semplice
    },
    {
        id: 2,
        title: "LIVELLO 2: FORMULE MAGICHE",
        msg: "Mancano i totali. Chiedi a Gemini di creare la formula.",
        glitchCount: 3,
        geminiTask: 'formula',
        pipes: 'medium'
    },
    {
        id: 3,
        title: "LIVELLO 3: ANALISI",
        msg: "Il report √® vuoto. Genera un grafico con Gemini.",
        glitchCount: 4,
        geminiTask: 'chart',
        pipes: 'complex'
    }
];

// DOMANDE GEMINI (Training Content)
const QUIZ_DB = {
    cleaning: {
        q: "Hai una colonna con 'Berlino, DE' e 'Parigi, FR'. Vuoi separare Citt√† e Nazione. Che fai?",
        opts: [
            { txt: "Scrivo a mano ogni cella (Lento)", correct: false },
            { txt: "Uso Smart Fill: faccio un esempio e Gemini completa il resto (Veloce!)", correct: true, feedback: "Esatto! Smart Fill riconosce i pattern." },
            { txt: "Cerco una formula complessa su Google", correct: false }
        ]
    },
    formula: {
        q: "Devi sommare le vendite, ma solo se lo Status √® 'Spedito'. Non ricordi la formula SUMIF.",
        opts: [
            { txt: "Prompt: 'Calcola somma vendite se status √® Spedito'", correct: true, feedback: "Bravo! Gemini scrive la formula =SUMIF per te." },
            { txt: "Provo a indovinare la formula a caso", correct: false },
            { txt: "Uso la calcolatrice del telefono", correct: false }
        ]
    },
    chart: {
        q: "Il manager vuole vedere subito il brand che ha venduto di pi√π.",
        opts: [
            { txt: "Creo una tabella pivot manuale", correct: false },
            { txt: "Disegno il grafico su un foglio di carta", correct: false },
            { txt: "Prompt: 'Crea un grafico a barre delle vendite per Brand'", correct: true, feedback: "Esatto! Il grafico appare all'istante." }
        ]
    }
};

// --- MOTORE DI GIOCO ---

// Tipi di Tubo (Nord, Est, Sud, Ovest) 1=Aperto, 0=Chiuso
const PIPE_SHAPES = {
    I: [1, 0, 1, 0], // Dritto
    L: [1, 1, 0, 0], // Curva
    T: [1, 1, 1, 0], // T
    X: [1, 1, 1, 1], // Incrocio
    S: [0, 1, 0, 0], // START (Verso destra)
    E: [0, 0, 0, 1]  // END (Riceve da sinistra)
};

class Tile {
    constructor(x, y, shapeType, isGlitch) {
        this.x = x;
        this.y = y;
        this.shape = shapeType; 
        this.conns = [...shapeType]; // Connessioni attuali [N,E,S,W]
        this.isGlitch = isGlitch; // Se √® un glitch (blocco rosso)
        this.isFixed = !isGlitch; // Se √® utilizzabile
        this.hasWater = false;
        
        // Ruota casualmente all'inizio (tranne Start/End)
        if (!this.isStart() && !this.isEnd()) {
            let r = Math.floor(Math.random() * 4);
            for(let i=0; i<r; i++) this.rotate(true);
        }
    }

    rotate(force = false) {
        if (!force && (!this.isFixed || this.isStart() || this.isEnd())) return;
        // Shift array: [N, E, S, W] -> [W, N, E, S]
        this.conns.unshift(this.conns.pop());
    }

    isStart() { return this.x === 0 && this.y === 0; }
    isEnd() { return this.x === COLS-1 && this.y === ROWS-1; }
}

function initLevel(lvlIdx) {
    const config = LEVELS[lvlIdx-1];
    document.getElementById('level-display').innerText = config.id;
    document.getElementById('status-display').innerText = "COSTRUZIONE";
    document.getElementById('status-display').style.color = "white";
    
    grid = [];
    zally = {x:0, y:0};
    isFlowing = false;

    // Generazione Griglia
    for(let y=0; y<ROWS; y++) {
        let row = [];
        for(let x=0; x<COLS; x++) {
            let type = PIPE_SHAPES.I;
            let isGlitch = false;
            
            // Logica semplice generazione mappa
            let r = Math.random();
            if (r < 0.4) type = PIPE_SHAPES.L;
            else if (r < 0.6) type = PIPE_SHAPES.T;
            else if (r < 0.7) type = PIPE_SHAPES.X;

            if (x===0 && y===0) type = PIPE_SHAPES.S;
            else if (x===COLS-1 && y===ROWS-1) type = PIPE_SHAPES.E;
            else {
                // Aggiungi glitch casuali
                if (Math.random() < (config.glitchCount / 100) * 3) isGlitch = true;
            }
            
            row.push(new Tile(x, y, type, isGlitch));
        }
        grid.push(row);
    }
    // Forza orientamento Start
    grid[0][0].conns = [0, 1, 0, 0];

    draw();
}

// --- INPUT E CONTROLLI ---

function input(key) {
    if (!gameActive) return;
    
    // Movimento Zally
    if (key === 'ArrowUp' && zally.y > 0) zally.y--;
    if (key === 'ArrowDown' && zally.y < ROWS-1) zally.y++;
    if (key === 'ArrowLeft' && zally.x > 0) zally.x--;
    if (key === 'ArrowRight' && zally.x < COLS-1) zally.x++;

    // Azioni
    if (key === 'Space' || key === ' ') {
        let t = grid[zally.y][zally.x];
        t.rotate();
    }
    if (key === 'Enter') checkGemini();
    if (key === 'f' || key === 'F') testFlow();

    draw();
}

document.addEventListener('keydown', (e) => input(e.key));

// --- LOGICA GEMINI ---

function checkGemini() {
    let t = grid[zally.y][zally.x];
    if (t.isGlitch && !t.isFixed) {
        openGeminiQuiz();
    }
}

function openGeminiQuiz() {
    gameActive = false; // Pausa input gioco
    const config = LEVELS[level-1];
    const data = QUIZ_DB[config.geminiTask];
    
    const ui = document.getElementById('gemini-ui');
    document.getElementById('gemini-question').innerText = data.q;
    const optsDiv = document.getElementById('gemini-options');
    optsDiv.innerHTML = '';

    data.opts.forEach(opt => {
        let div = document.createElement('div');
        div.className = 'quiz-option';
        div.innerText = opt.txt;
        div.onclick = () => solveGemini(opt.correct, opt.feedback);
        optsDiv.appendChild(div);
    });

    ui.style.display = 'block';
}

function solveGemini(isCorrect, feedback) {
    const ui = document.getElementById('gemini-ui');
    
    if (isCorrect) {
        // Fix Tile
        let t = grid[zally.y][zally.x];
        t.isGlitch = false;
        t.isFixed = true;
        
        ui.style.display = 'none';
        gameActive = true;
        alert("‚ú® GEMINI: " + feedback); // Semplice feedback
        draw();
    } else {
        alert("‚ö†Ô∏è Non √® la soluzione migliore. Riprova!");
    }
}

// --- LOGICA FLUSSO ACQUA (SEMPLIFICATA) ---

function testFlow() {
    if (isFlowing) return; // Gi√† attivo
    
    // Reset acqua
    for(let y=0; y<ROWS; y++) 
        for(let x=0; x<COLS; x++) grid[y][x].hasWater = false;

    isFlowing = true;
    document.getElementById('status-display').innerText = "TEST FLUSSO...";
    document.getElementById('status-display').style.color = "#00bcd4";

    // Simulazione passo-passo
    let queue = [{x:0, y:0}];
    grid[0][0].hasWater = true;

    let timer = setInterval(() => {
        let newFlow = false;
        let nextQueue = [];

        queue.forEach(curr => {
            let t = grid[curr.y][curr.x];
            // Controlla vicini [N, E, S, W]
            const dirs = [
                {x:0, y:-1, idx:0, opp:2}, // N
                {x:1, y:0,  idx:1, opp:3}, // E
                {x:0, y:1,  idx:2, opp:0}, // S
                {x:-1, y:0, idx:3, opp:1}  // W
            ];

            dirs.forEach(d => {
                // Se tubo corrente ha uscita in questa direzione
                if (t.conns[d.idx]) {
                    let nx = curr.x + d.x;
                    let ny = curr.y + d.y;
                    
                    // Se vicino esiste
                    if (nx>=0 && nx<COLS && ny>=0 && ny<ROWS) {
                        let neighbor = grid[ny][nx];
                        // Se vicino ha entrata opposta E non √® glitch E non ha acqua
                        if (neighbor.conns[d.opp] && !neighbor.isGlitch && !neighbor.hasWater) {
                            neighbor.hasWater = true;
                            nextQueue.push({x:nx, y:ny});
                            newFlow = true;
                        }
                    }
                }
            });
        });

        queue = nextQueue;
        draw();

        // Controllo Fine o Blocco
        let endTile = grid[ROWS-1][COLS-1];
        if (endTile.hasWater) {
            clearInterval(timer);
            levelComplete(true);
        } else if (!newFlow) {
            clearInterval(timer);
            levelComplete(false);
        }
    }, 200); // Velocit√† animazione
}

function levelComplete(success) {
    isFlowing = false;
    const modal = document.getElementById('result-modal');
    const title = document.getElementById('result-title');
    const msg = document.getElementById('result-msg');
    const btn = document.getElementById('result-btn');

    if (success) {
        title.innerText = "MISSIONE COMPIUTA!";
        title.style.color = "#4caf50";
        msg.innerText = "Hai connesso i dati perfettamente grazie a Gemini!";
        btn.innerText = "PROSSIMO LIVELLO";
        btn.onclick = nextLevel;
    } else {
        title.innerText = "PERDITA RILEVATA!";
        title.style.color = "#e91e63";
        msg.innerText = "L'acqua non √® arrivata al Report. Controlla le connessioni e riprova.";
        btn.innerText = "RIPARA TUBI";
        btn.onclick = () => {
            modal.style.display = 'none';
            document.getElementById('status-display').innerText = "COSTRUZIONE";
            document.getElementById('status-display').style.color = "white";
            // Pulisci acqua
            for(let y=0; y<ROWS; y++) 
                for(let x=0; x<COLS; x++) grid[y][x].hasWater = false;
            draw();
        };
    }
    modal.style.display = 'block';
}

function nextLevel() {
    document.getElementById('result-modal').style.display = 'none';
    level++;
    if (level > LEVELS.length) {
        alert("COMPLIMENTI! SEI UN GEMINI CHAMPION!");
        level = 1;
    }
    initLevel(level);
}

// --- DISEGNO ---

function draw() {
    ctx.fillStyle = COLORS.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Disegna Griglia e Tubi
    for(let y=0; y<ROWS; y++) {
        for(let x=0; x<COLS; x++) {
            drawTile(grid[y][x], x*TILE_SIZE, y*TILE_SIZE);
        }
    }

    // Disegna Zally
    drawZally(zally.x*TILE_SIZE, zally.y*TILE_SIZE);
}

function drawTile(t, x, y) {
    const cx = x + TILE_SIZE/2;
    const cy = y + TILE_SIZE/2;
    const w = TILE_SIZE/3;

    // Bordo cella
    ctx.strokeStyle = '#333';
    ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);

    if (t.isGlitch && !t.isFixed) {
        // Cella Glitch (Rosso)
        ctx.fillStyle = COLORS.glitch;
        ctx.fillRect(x+5, y+5, TILE_SIZE-10, TILE_SIZE-10);
        ctx.fillStyle = 'white';
        ctx.font = '20px Arial';
        ctx.fillText("?", cx-5, cy+7);
        return;
    }

    // Colore Tubo
    ctx.fillStyle = t.hasWater ? COLORS.pipeWater : COLORS.pipeNormal;

    // Centro
    ctx.fillRect(cx - w/2, cy - w/2, w, w);
    
    // Bracci
    if (t.conns[0]) ctx.fillRect(cx - w/2, y, w, TILE_SIZE/2); // N
    if (t.conns[1]) ctx.fillRect(cx, cy - w/2, TILE_SIZE/2, w); // E
    if (t.conns[2]) ctx.fillRect(cx - w/2, cy, w, TILE_SIZE/2); // S
    if (t.conns[3]) ctx.fillRect(x, cy - w/2, TILE_SIZE/2, w); // W

    // Etichette Start/End
    if (t.isStart()) {
        ctx.fillStyle = '#fff';
        ctx.font = '10px Arial';
        ctx.fillText("DATI", x+5, y+15);
    }
    if (t.isEnd()) {
        ctx.fillStyle = '#fff';
        ctx.font = '10px Arial';
        ctx.fillText("REPORT", x+5, y+55);
    }
}

function drawZally(x, y) {
    // Cursore Zally
    ctx.strokeStyle = COLORS.zally;
    ctx.lineWidth = 4;
    ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
    
    // Sprite Semplice
    ctx.fillStyle = COLORS.zally;
    ctx.beginPath();
    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, 10, 0, Math.PI*2);
    ctx.fill();
}

// Avvio
function startGame() {
    document.getElementById('start-modal').style.display = 'none';
    gameActive = true;
    initLevel(1);
}

</script>
</body>
</html>
